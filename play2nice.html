<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>QuickMatch — Play Instantly</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1: #071022;
      --bg2: #081024;
      --panel: rgba(255,255,255,0.03);
      --muted: #9fb0c8;
      --accent: #7c5cff;
      --accent2: #00d4ff;
      --glass: rgba(255,255,255,0.04);
      --glass-2: rgba(255,255,255,0.02);
      --success: #27e3a9;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;}
    html,body{height:100%;margin:0;background:
      radial-gradient(800px 400px at 10% 10%, rgba(124,92,255,0.10), transparent 8%),
      radial-gradient(600px 300px at 90% 90%, rgba(0,212,255,0.06), transparent 8%),
      linear-gradient(180deg,var(--bg1),var(--bg2));
      color:#e9f2ff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:1100px;margin:40px auto;padding:18px;}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
    .brand{display:flex;align-items:center;gap:12px;}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;font-size:18px;box-shadow:0 8px 30px rgba(124,92,255,0.12);}
    h1{margin:0;font-size:20px;}
    .subtitle{color:var(--muted);font-size:13px;margin-top:4px;}
    .layout{display:grid;grid-template-columns:360px 1fr;gap:18px;align-items:start;}

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 12px 40px rgba(3,8,20,0.6);}
    .me{display:flex;gap:12px;align-items:center}
    .avatar{width:64px;height:64px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;color:white;box-shadow:0 12px 30px rgba(0,0,0,0.6)}
    .meinfo .name{font-weight:700}
    .meinfo .id{color:var(--muted);font-size:13px;margin-top:4px}

    .inputRow{display:flex;gap:8px;margin-top:12px}
    input[type="text"]{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;outline:none}
    select{padding:10px;border-radius:10px;background:var(--glass);border:1px solid rgba(255,255,255,0.04);color:inherit}
    .btn{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(124,92,255,0.18)}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);box-shadow:none}

    .playersList{margin-top:14px;display:flex;flex-direction:column;gap:10px;max-height:360px;overflow:auto;padding-right:6px}
    .playerRow{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02)}
    .playerRow .pName{font-weight:700}
    .playerRow .pId{color:var(--muted);font-size:12px;margin-left:auto}
    .pMeta{display:flex;flex-direction:column}

    /* right: game card */
    .gameArea{display:flex;flex-direction:column;gap:12px}
    .gameCanvasWrap{height:420px;padding:12px;display:flex;flex-direction:column;gap:12px}
    canvas{flex:1;border-radius:12px;background:linear-gradient(180deg,#f8fbff,#eef7ff);box-shadow:0 16px 50px rgba(2,6,23,0.6);border:1px solid rgba(0,0,0,0.05)}
    .statusRow{display:flex;align-items:center;justify-content:space-between}
    .hint{color:var(--muted);font-size:13px}

    .modal{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:80;backdrop-filter: blur(6px);
    }
    .modalCard{width:420px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
    .modalTitle{font-weight:800;margin-bottom:6px}
    .row{display:flex;gap:8px;align-items:center}

    footer.small{color:var(--muted);font-size:12px;margin-top:8px;text-align:center}
    @media (max-width:920px){
      .layout{grid-template-columns:1fr}
      .gameCanvasWrap{height:360px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">QM</div>
        <div>
          <h1>QuickMatch</h1>
          <div class="subtitle">Mở là có ID • Mời bạn ngay • Co-op / PvP</div>
        </div>
      </div>
      <div class="subtitle">No login — Instant play</div>
    </div>

    <div class="layout">
      <div class="card">
        <div class="me">
          <div id="avatar" class="avatar">P</div>
          <div class="meinfo">
            <div class="name" id="meName">Player</div>
            <div class="id" id="meId">ID: 100...002</div>
            <div class="small" style="margin-top:6px;color:var(--muted)">Tên tạm — đổi nếu muốn. Tên đang online là duy nhất.</div>
          </div>
        </div>

        <div class="inputRow">
          <input id="nameInput" type="text" placeholder="Đổi tên hiển thị (tùy chọn)" />
          <button id="setNameBtn" class="btn ghost">Đổi</button>
        </div>

        <div class="inputRow" style="margin-top:12px">
          <input id="inviteInput" type="text" placeholder="Nhập tên hoặc ID để mời" />
          <select id="modeSelect"><option value="coop">Co-op</option><option value="pvp">PvP</option></select>
          <button id="inviteBtn" class="btn">Mời</button>
        </div>

        <div class="small" style="margin-top:10px;color:var(--muted)">Hoặc bấm Mời trên người chơi trong danh sách</div>

        <div class="playersList" id="playersList"></div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="refreshBtn" class="btn ghost">Làm mới</button>
          <button id="copyIdBtn" class="btn ghost">Sao chép ID</button>
        </div>
      </div>

      <div class="gameArea">
        <div class="card gameCanvasWrap">
          <div class="statusRow">
            <div><strong>Trạng thái:</strong> <span id="statusText">Đang ở Lobby</span></div>
            <div class="hint">Di chuyển: mũi tên / WASD</div>
          </div>
          <canvas id="gameCanvas" width="760" height="340"></canvas>
          <div class="row" style="justify-content:space-between">
            <div class="hint">Chế độ: <strong id="gameMode">—</strong></div>
            <div style="display:flex;gap:8px">
              <button id="leaveBtn" class="btn ghost">Thoát game</button>
            </div>
          </div>
        </div>
        <footer class="small">Nếu đối thủ rời hoặc offline, bạn sẽ được trở về Lobby tự động.</footer>
      </div>
    </div>
  </div>

  <!-- Invite modal template (hidden by default) -->
  <div id="inviteModal" style="display:none" class="modal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalTitle" id="inviteModalTitle">Lời mời</div>
      <div id="inviteModalBody" style="margin-bottom:12px;color:var(--muted)"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="declineInviteBtn" class="btn ghost">Từ chối</button>
        <button id="acceptInviteBtn" class="btn">Chấp nhận</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    (function(){
      const socket = io();

      // UI refs
      const meNameEl = document.getElementById('meName');
      const meIdEl = document.getElementById('meId');
      const avatarEl = document.getElementById('avatar');
      const nameInput = document.getElementById('nameInput');
      const setNameBtn = document.getElementById('setNameBtn');
      const inviteInput = document.getElementById('inviteInput');
      const inviteBtn = document.getElementById('inviteBtn');
      const playersList = document.getElementById('playersList');
      const refreshBtn = document.getElementById('refreshBtn');
      const copyIdBtn = document.getElementById('copyIdBtn');
      const statusText = document.getElementById('statusText');
      const gameModeEl = document.getElementById('gameMode');
      const leaveBtn = document.getElementById('leaveBtn');
      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d');

      const inviteModal = document.getElementById('inviteModal');
      const inviteModalTitle = document.getElementById('inviteModalTitle');
      const inviteModalBody = document.getElementById('inviteModalBody');
      const acceptInviteBtn = document.getElementById('acceptInviteBtn');
      const declineInviteBtn = document.getElementById('declineInviteBtn');

      let me = null;
      let currentRoom = null;
      let playersState = {};
      let animRequest = null;
      let pendingInvite = null;

      function initialsFromName(name){
        const parts = (name || '').split(/\s+/).filter(Boolean);
        if (parts.length === 0) return 'P';
        if (parts.length === 1) return parts[0].slice(0,2).toUpperCase();
        return (parts[0][0] + parts[1][0]).toUpperCase();
      }
      function colorFromId(id){
        let h = 0;
        for (let i=0;i<id.length;i++){ h = ((h<<5)-h) + id.charCodeAt(i); h |= 0; }
        const hue = Math.abs(h) % 360;
        return `linear-gradient(135deg,hsl(${hue} 80% 55%), hsl(${(hue+80)%360} 80% 55%))`;
      }

      // Socket handlers
      socket.on('connect', ()=> console.log('connected', socket.id));

      socket.on('welcome', (data) => {
        me = { id: data.id, name: data.name };
        meNameEl.textContent = me.name;
        meIdEl.textContent = 'ID: ' + me.id;
        avatarEl.textContent = initialsFromName(me.name);
        avatarEl.style.background = colorFromId(me.id);
        nameInput.value = me.name;
      });

      socket.on('player_list_update', (list) => {
        playersList.innerHTML = '';
        list.forEach(p => {
          if (me && p.id === me.id) return;
          const row = document.createElement('div');
          row.className = 'playerRow';
          const avatarHTML = `<div style="width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;background:${colorFromId(p.id)};color:#fff">${initialsFromName(p.name)}</div>`;
          row.innerHTML = `${avatarHTML}<div class="pMeta"><div class="pName">${p.name}</div><div class="pId">${p.id}</div></div><div style="margin-left:auto"><button class="btn ghost btnInvite">Mời</button></div>`;
          const btn = row.querySelector('.btnInvite');
          btn.addEventListener('click', () => {
            inviteInput.value = p.id;
            inviteBtn.click();
          });
          playersList.appendChild(row);
        });
      });

      // Invite UI
      inviteBtn.addEventListener('click', () => {
        const q = inviteInput.value.trim();
        if (!q) return toast('Nhập tên hoặc ID để mời');
        const mode = document.getElementById('modeSelect').value;
        socket.emit('invite', { to: q, mode }, (res) => {
          if (!res.ok) return toast('Không gửi được: ' + (res.error||''));
          toast('Lời mời đã gửi');
          statusText.textContent = 'Đã gửi lời mời…';
        });
      });

      socket.on('invite_incoming', (data) => {
        pendingInvite = data;
        inviteModalTitle.textContent = 'Lời mời từ ' + data.from.name;
        inviteModalBody.innerHTML = `<div style="color:var(--muted)">ID: ${data.from.id}<br/>Chế độ: <strong>${data.mode.toUpperCase()}</strong></div>`;
        inviteModal.style.display = 'flex';
      });

      acceptInviteBtn.addEventListener('click', () => {
        if (!pendingInvite) return;
        socket.emit('respond_invite', { fromId: pendingInvite.from.id, accept: true, mode: pendingInvite.mode }, (res) => {
          if (!res.ok) toast('Không thể chấp nhận: ' + (res.error||''));
          inviteModal.style.display = 'none';
          pendingInvite = null;
        });
      });
      declineInviteBtn.addEventListener('click', () => {
        if (!pendingInvite) return;
        socket.emit('respond_invite', { fromId: pendingInvite.from.id, accept: false }, (res) => {});
        inviteModal.style.display = 'none';
        pendingInvite = null;
      });

      socket.on('invite_response', (data) => {
        toast(`${data.from.name} đã từ chối lời mời`);
      });

      socket.on('start_game', (payload) => {
        currentRoom = payload.roomId;
        gameModeEl.textContent = payload.mode.toUpperCase();
        statusText.textContent = 'Đang chơi';
        // init state
        playersState = {};
        payload.players.forEach((p, idx) => {
          playersState[p.id] = { x: 160 + idx*360, y: 160, id: p.id, name: p.name, color: null };
        });
        // draw immediately
        startLoop();
      });

      socket.on('game_state', (data) => {
        if (!currentRoom || data.roomId !== currentRoom) return;
        const st = data.state && data.state.playersState;
        if (st) {
          for (const pid in st) {
            playersState[pid] = Object.assign(playersState[pid] || { id: pid, name: pid, color: null }, st[pid]);
          }
        }
      });

      socket.on('opponent_left', (data) => {
        toast('Đối thủ đã rời: ' + data.by.name);
        stopAndReset();
      });
      socket.on('opponent_offline', (data) => {
        toast('Đối thủ offline: ' + data.name);
        stopAndReset();
      });

      // set name
      setNameBtn.addEventListener('click', () => {
        const desired = nameInput.value.trim();
        if (!desired) return toast('Nhập tên');
        socket.emit('set_name', { name: desired }, (res) => {
          if (!res.ok) return toast(res.error || 'Không đổi được tên');
          me.name = res.name;
          meNameEl.textContent = me.name;
          avatarEl.textContent = initialsFromName(me.name);
          avatarEl.style.background = colorFromId(me.id);
          toast('Đổi tên thành công');
        });
      });

      refreshBtn.addEventListener('click', () => {
        socket.emit('list_players', null, (res) => {
          if (res && res.ok) {
            // server broadcasts updated list — nothing else needed
            toast('Đã làm mới');
          }
        });
      });

      copyIdBtn.addEventListener('click', () => {
        if (!me) return;
        navigator.clipboard && navigator.clipboard.writeText(me.id).then(()=> {
          copyIdBtn.textContent = 'Đã sao chép';
          setTimeout(()=> copyIdBtn.textContent = 'Sao chép ID', 1200);
        }).catch(()=> toast('Không thể sao chép'));
      });

      leaveBtn.addEventListener('click', () => {
        if (!currentRoom) return;
        socket.emit('leave_game', { roomId: currentRoom }, () => {});
        stopAndReset();
      });

      // Movement & rendering
      const keys = {};
      window.addEventListener('keydown', (e) => keys[e.key] = true);
      window.addEventListener('keyup', (e) => keys[e.key] = false);

      function updateMovement() {
        if (!me || !currentRoom) return;
        const pos = playersState[me.id] || { x: 160, y:160 };
        let dx=0, dy=0;
        if (keys['ArrowUp'] || keys['w'] || keys['W']) dy -= 3;
        if (keys['ArrowDown'] || keys['s'] || keys['S']) dy += 3;
        if (keys['ArrowLeft'] || keys['a'] || keys['A']) dx -= 3;
        if (keys['ArrowRight'] || keys['d'] || keys['D']) dx += 3;
        pos.x = Math.max(40, Math.min(canvas.width-40, pos.x + dx));
        pos.y = Math.max(40, Math.min(canvas.height-40, pos.y + dy));
        playersState[me.id] = pos;
        socket.emit('player_update', { roomId: currentRoom, pos });
      }

      function draw() {
        const w = canvas.width, h = canvas.height;
        ctx.clearRect(0,0,w,h);

        // soft grid background
        ctx.globalAlpha = 0.03;
        ctx.fillStyle = '#022032';
        for (let x = 0; x < w; x += 40) ctx.fillRect(x,0,1,h);
        for (let y = 0; y < h; y += 40) ctx.fillRect(0,y,w,1);
        ctx.globalAlpha = 1;

        for (const pid in playersState) {
          const p = playersState[pid];
          const isMe = me && pid === me.id;
          // shadow
          ctx.beginPath();
          ctx.fillStyle = 'rgba(2,6,23,0.12)';
          ctx.ellipse(p.x, p.y + 22, 40, 12, 0, 0, Math.PI*2);
          ctx.fill();

          // body rounded rect
          ctx.beginPath();
          roundRect(ctx, p.x - 36, p.y - 36, 72, 72, 14);
          ctx.fillStyle = isMe ? '#2b8aef' : '#ef6b6b';
          if (!p.color) { p.color = (isMe ? '#2b8aef' : '#ef6b6b'); }
          ctx.fillStyle = p.color;
          ctx.fill();

          // initials
          ctx.fillStyle = '#fff';
          ctx.font = isMe ? '700 18px Inter' : '700 14px Inter';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          const initials = (p.name || p.id).split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
          ctx.fillText(initials, p.x, p.y);

          // name tag
          ctx.fillStyle = '#022';
          ctx.font = '600 13px Inter';
          ctx.fillText(p.name || p.id, p.x, p.y + 52);
        }
      }

      function roundRect(ctx, x, y, w, h, r) {
        ctx.beginPath();
        ctx.moveTo(x + r, y);
        ctx.arcTo(x + w, y, x + w, y + h, r);
        ctx.arcTo(x + w, y + h, x, y + h, r);
        ctx.arcTo(x, y + h, x, y, r);
        ctx.arcTo(x, y, x + w, y, r);
        ctx.closePath();
      }

      function loop(){
        updateMovement();
        draw();
        animRequest = requestAnimationFrame(loop);
      }
      function startLoop(){
        if (animRequest) cancelAnimationFrame(animRequest);
        animRequest = requestAnimationFrame(loop);
      }
      function stopAndReset(){
        if (animRequest) cancelAnimationFrame(animRequest);
        animRequest = null;
        currentRoom = null;
        playersState = {};
        statusText.textContent = 'Đang ở Lobby';
        gameModeEl.textContent = '—';
        ctx.clearRect(0,0,canvas.width,canvas.height);
        // friendly lobby hint
        ctx.fillStyle = '#f2f7fb';
        ctx.font = '600 18px Inter';
        ctx.textAlign = 'center';
        ctx.fillText('Chưa vào phòng — mời hoặc nhận lời mời để chơi', canvas.width/2, canvas.height/2 - 12);
        ctx.font = '400 13px Inter';
        ctx.fillText('Di chuyển bằng mũi tên hoặc WASD khi vào phòng', canvas.width/2, canvas.height/2 + 12);
      }

      // small toast
      function toast(msg){
        const t = document.createElement('div');
        t.textContent = msg;
        t.style.position = 'fixed';
        t.style.left = '50%';
        t.style.transform = 'translateX(-50%)';
        t.style.bottom = '30px';
        t.style.padding = '10px 16px';
        t.style.background = 'linear-gradient(90deg,var(--accent),var(--accent2))';
        t.style.color = '#fff';
        t.style.borderRadius = '12px';
        t.style.boxShadow = '0 10px 30px rgba(2,6,23,0.6)';
        t.style.zIndex = '120';
        document.body.appendChild(t);
        setTimeout(()=> t.style.opacity = '0.95', 20);
        setTimeout(()=> { t.style.transition = 'opacity 300ms'; t.style.opacity = '0'; setTimeout(()=> t.remove(), 350); }, 1500);
      }

      // initial canvas hint
      stopAndReset();

    })();
  </script>
</body>
</html>
